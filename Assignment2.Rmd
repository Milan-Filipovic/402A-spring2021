---
title: "Assignment 2"
author: "Milan Filipovic"
date: "April 13, 2021"
output: html_document
---


```{r}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, fig.align = 'center')
```

```{r, include = F, eval = T}
library(haven)
library(tidyverse)
library(data.table)
library(gtsummary)
library(ggplot2)
```

*2.* Briefly outline statistical procedures that may help answer the four main statistical questions listed on Page 105 of Wolfe's casebook study.

**Solution**:

The four statistical questions listed on Page 105 are as follows:

1. Do oxygen or intubation therapy cause BPD?
2. How are the pathological indices related to BPD?
3. Which background or health variables indicates high risk for contracting BPD?
4. How serious is BPD to an infant's life?


Brief statistical procedures that may help answer the four main statistical questions include t-test, chi-square tests, and multiple regression techniques. Initial descriptive statistics must be conducted to examine the data and analyze the appropriate sample.

First we read in the data set. 

```{r}
getwd()
BPD = read_dta("bpd.dta")
BPD_tble <- as_tibble(BPD) %>% print()
```

Using glimpse, we see that all variable types are numerical
```{r}
glimpse(BPD_tble)
print(BPD_tble, width = Inf)

#create a categorical variable for gender
BPD_tble %>% mutate(gender = ifelse(BPD_tble$sex == 1, "male", "female")) 
```


*3a.* Create a demographic table describing the study population. (Who was studied? How many were studied? To whom could you generalize results?) Include the following descriptions: 


* % female; `gender`
* median and range of year of birth; `bxy`
* % APGAR scores; `agar`
* median and IQR gestational age; `gage`
* median and IQR birthweight; `bwt`
* median and IQR age at onset of respiratory symptoms; `rage`
* median and IQR age at onset of ventilatory assistance; `vage`

```{r}
#
demographic_table <- BPD_tble %>% 
  mutate(gender = ifelse(BPD_tble$sex == 1, "male", "female")) %>%  
  select(gender, bxy, agar, gage, bwt, rage, vage) %>% 
  tbl_summary(
    statistic = c("agar","gage","bwt", "rage", "vage") ~ "{median} ({p25}, {p75})",
    digits = all_continuous() ~ 1)
  
range(BPD_tble$bxy)
#range of birth year included in table attribute
demographic_table
```



*3b.* Plots (histograms or box plots) and summary statistics for the distributions of: 

i. hours of exposure to low concentrations of elevated oxygen 
ii. hours of exposure to medium concentrations of elevated oxygen 
iii. hours of exposure to high concentrations of elevated oxygen 
iv. hours of duration of endotracheal intubation 
v. hours of duration of assisted ventilation 


```{r 3b i}
BPD_tble %>% ggplot(mapping = aes(x = lo2)) +
  geom_histogram(binwidth = 200, fill="blue")+
  ggtitle("Hours of Exposure to Low Concentration (23-39%) of Elevated Oxygen") +
  labs(x = "Time (hours)") +
  theme_bw()
print(sort(BPD_tble$lo2))
```
We see that the distribution is right skewed, with outliers at the high extreme.
 
```{r 3b ii}
BPD_tble %>% ggplot(mapping = aes(x = mo2)) +
  geom_histogram(fill="blue")+
  labs(x = "Time (hours)") +
  ggtitle("Hours of Exposure to Mid Concentration (40-79%) of Elevated Oxygen") +
  theme_bw()
print(sort(BPD_tble$mo2))
```


```{r 3b iii}
BPD_tble %>% ggplot(mapping = aes(x = ho2)) +
  geom_histogram(fill="blue") +
  labs(x = "Time (hours)") +
  ggtitle("Hours of Exposure to High Concentration (80-100%) of Elevated Oxygen") +
  theme_bw()
print(sort(BPD_tble$ho2))
```
This distribution is also right skewed. The scale of time is much lower then mid and low oxygen exposure.


Next we examine the distribution of the duration of endotrachael intubation `idur`.
```{r 3b iv}
BPD_tble %>% ggplot(mapping = aes(x = idur)) +
  geom_histogram(fill = "blue") + 
  labs(x = "Time (hours)") +
  ggtitle("Duration of Endotracheal Intubation") +
  theme_bw()

```
The distribution appears heavily right skewed, with many potential outliers.

Next we examine the distribution of the duration of assisted ventilation intubation `vdur`.
```{r 3b v}
BPD_tble %>% ggplot(mapping = aes(x = vdur)) +
  geom_histogram(fill = "blue") + 
  labs(x = "Time (hours)") +
  ggtitle("Duration of Ventillatory Assistance") +
  theme_classic()
```

c. Counts (or bar graphs) of RDS and radiographic BPD scores. How many infants were classified as having RDS, very severe RDS, and BPD? 

Looking at the counts for RDS in our study population, we see that 296 (99.0%) infants were classified as having RDS (score of 1 or higher), of which 40 (13.4%) infants were classified as having very severe RDS (score of 5). 1 (0.0%) infant did not have any data on RDS classification. 

Looking at the counts for BPD in our study population, 71 (23.7%) infants were classified as having BPD (having reached stage III or stage IV). For the purposes of overall descriptive analysis here, the counts here did not filter for only infants that survived 3 days or more.


```{r}
# rds
BPD_tble %>% 
  mutate(rds = as.factor(rds)) %>% 
  ggplot(mapping = aes(rds)) +
  geom_bar(aes(fill = rds), colour = "black") +
  scale_fill_brewer(palette = "Pastel1") +
  labs(x = "RDS Score (0-5)", y = "Count",
       title = "RDS Severity Scores for Study Population (N = 299)") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, size = 3) +
  theme_bw()

# bpd
BPD_tble %>% 
  mutate(bpd = as.factor(bpd)) %>% 
  ggplot(mapping = aes(bpd)) +
  geom_bar(aes(fill = bpd), colour = "black") +
  scale_fill_brewer(palette = "Pastel1") +
  labs(x = "Stage of BPD (max radiological score x 10)", y = "Count",
       title = "Stages of BPD Present in Study Population (N = 299)") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, size = 3) +
  theme_bw()

```

d. Missing data and outliers. Identify variables with large numbers of missing 
data values (say, >20% missing). List variables with extreme outliers. 

Identifying variables with > 20% missing for a dataset containing 299 observations is equivalent to identifying variables with > 60 missing values.
We see that in the bpd data set, 8 variables (`agar`, `brmu`, `puin`, `hyme`. `alin`, `emph`, `lbpd`, `hema`) have more than 60 missing values.

```{r 3d, fig.height = 10, fig.width = 12}

# NA counts for each variable
missing <- BPD_tble %>%
  select(everything()) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  print(width = Inf)

# extreme outlier identification 
# excluded pid since pid is unique
# variables with 5 unique values or less were excluded 

df <- reshape2::melt(BPD_tble[,-c(1,2, 14, 18:24)])
ggplot(df, aes(x = value)) +
  facet_wrap(~variable, scales = "free_x") +
  geom_histogram() +
  theme_bw()

```


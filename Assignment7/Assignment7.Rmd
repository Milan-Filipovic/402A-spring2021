---
title: "B402A Assignment 7"
author: "Lillian Chen, Milan Filipovic, Vivian Truong"
date: "5/24/2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(haven)
library(gt)
library(tidyr)
library(ggforce) #can be used for large facet grids
```

```{r}

data <- readxl::read_xlsx("./20210521_402a.xlsx", col_names = T, skip = 1)

str(data)

dataclean <- data %>% 
  rename(sample = "Sample #",
         patientid = "Patient ID",
         IRI = "IRI Score (â€“,+)",
         visittype = "Visit Type") %>% 
  mutate(across(starts_with("CYTO"),
                ~ dplyr::case_when(
                  str_starts(.x, "<") == T ~ as.numeric(str_sub(.x, 2, -2)),
                  str_starts(.x, ">") == T ~ as.numeric(str_sub(.x, 2, -2)) + 1,
                  str_starts(.x, "1|2|3|4|5|6|7|8|9|0") == T ~ as.numeric(.x)
                )))

```

```{r}
library(data.table)
isidata <- fread(file = "dataclean.csv", header = T, stringsAsFactors = F)
(isi_tble <- tibble(isidata))
```

We begin by visualizing the distribution of cytokine values 



```{r}


isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

## my attempt to facet in one plot. Does not look good
isi_tble %>% select(starts_with("CYT")) %>%
  gather() %>%
  ggplot(aes(value)) +
facet_wrap(~ key, scales ="free") +
# facet_grid_paginate(~ key, ncol = 3, nrow = 3, page = 2)
  geom_boxplot()
```

The Cytokine distributions are characterized by heavy right skew. 

Now log transform all Cytokines
```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

* Among the log transformed cytokine values, it is seen that that overall normality is improved. 
 + CYTO12 and CYTO 19 appears to have a similar distribution when looking at the histogram, with large left skew and lack of density left of the peak density. 
 + CYTO13 appears as if it may have another peak in the right tail. It is right skewed. 
* CYTO 15 appears to have several outliers in the higher range.
* CYTO16 appears right skewed. 
* CYTO18 appears to have lower outliers. 
* CYTO17 has many values below level of detection, therefore the transformation did not affect overall normality. 
* CYTO21 appears to have a large right skew, though it should be noted that many values were below level of detection in CYTO 21. 


### Now I'll take a look at how cytokines vary at each time value. 

First look at how cytokine values trend overtime
```{r}

library(ggpubr)

my_comparisons <- list(as.factor(c("LF", "PO")), as.factor(c("LF", "W1")), as.factor(c("PO", "W1"))) # comparisons for post-hoc tests

for(i in c(7:29)){
p <- isi_tble %>% 
  ggplot() +
  geom_boxplot(aes(x = visittype, y = log(isi_tble[[i]]), color = visittype)) + 
  stat_compare_means(aes( x = visittype, y = log(isi_tble[[i]])), method = "anova") +
 #stat_compare_means() + 
  ggtitle(paste("Histogram of Log", names(isi_tble)[i], "by Visit Type")) + 
  ylab("pg/mL") + 
  xlab("Visit Type") + 
  theme_classic() 
print(p)
}
```


Only CYTO4, CYTO16, and CYTO17 are not significantly different by one way anova. 

CYTO2 appears to decrease in both groups with time. 
The LF timepoint in CYTO6 appears higher in both groups. 
The LF timepoint in CYTO7 appears higher in both groups. 
The LF timepoint for CYTO13 concentration appears substantially higher in both groups compard to later timepoints. 
Concentration of CYTO15 appears to decrease with additional timepoints. 
Concentration of CYTO20 appears to decrease with additional timepoints. 
The concentration of CYTO23 in the LF timepoint appears lower than the PO and W1 timepoints.


Log Transforming Data to use in anova modelling. 
```{r}
liri_tble <- isi_tble %>% select(starts_with("CYT")) %>% 
  log() %>% #log transforms the cytokine data frame
  mutate(visittype = isi_tble$visittype, IRI = isi_tble$IRI) #add the factor variables back in 
liri_tble 
```


A one-way anova to compare cytokine concentrations for different timepoints. A pairwise comparison for all  
```{r}
responseList <- names(liri_tble)[c(1:23)]
modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype"))
                           aov(mF, data = liri_tble)
                })

HSDList    <- lapply(modelList, function(mod) {
                           TukeyHSD(mod)
                })
HSDList
########----------------a for loop can also be used-------------------
# for(i in c(1:23)){
# t <- TukeyHSD(modelList[[i]])
# print(paste("Results for", responseList[i]))
# print(t)
# print(str(t))
# }
```


Two-way Interaction Plot. Here median values are plotted over the visit types. It should be noted that CYTO4, CYTO16, and CYTO17 were not included because significance was not found in the anova test. 
```{r}
#need to add titles here 
#I use median instead of mean due to outliers in data set 
for(i in c(1:20)){
iri_tble2<- isi_tble %>% select(starts_with("CYTO"), -CYTO4, -CYTO16, -CYTO17)
    interaction.plot(x.factor = isi_tble$visittype,
                 response = log(iri_tble2[[i]]),
                 trace.factor = isi_tble$IRI,
                 fun = median,
                 ylab = "pg/mL",
                 xlab = paste(names(iri_tble2)[i], "Visit Type"),
                 col = c("red", "blue"),
                 trace.label = "IRI Status")
}
```


Possible interaction effect between ISI status and visit type in CYTO5, 7, 8, 14, 19 and 21. 


Running two-way anova 
```{r}
twoway_modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype*IRI"))
                           anova(lm(mF, data = isi_tble))
                })
twoway_modelList
```

A significant interaction is not observed in any of the models between ISI and visittype. 


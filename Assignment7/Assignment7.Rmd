---
title: "B402A Assignment 7"
author: "Lillian Chen, Milan Filipovic, Vivian Truong"
date: "5/24/2021"
output:
  html_document:
    df_print: paged
---

# Allyson Terry’s study on immunologic response to liver allograft injury

## Statement of statistical hypothesis(es):

1. What cytokines are significantly different between IRI- and IRI+ patients in the larger cohort of 100 liver transplant patients?

a. Do these cytokines influence IRI individually?
b. Do these cytokines influence IRI together?
c. Are any of these cytokines significantly different at more than one timepoint?

To determine if cytokines influence IRI individually, binary logistic regression will be conducted with IRI injury as the outcome variable, with difference  between timepoints in cytokine concentrations as covariates. 

To address what cytokines influence IRI together, a correlation plot was constructed to visualize related cytokines. 

To address whether cytokines significantly differ at more than one timepoint, separate one-way anovas with visit type as the factor variable will be conducted with each cytokine as the outcome variable. Furthermore, two-way anovas will be conducted for each cytokine concentration with visit type and IRI status as factor variables to explore if time and IRI status explain variation in cytokine concentration. 

2. What cytokines in the pre-transplant blood sample specifically correlate with:

a. Immune cell infiltration after transplant? (Inflammation score)
b. Dead cells in the liver after transplant? (Necrosis score)

## Background information:

Ischemia-reperfusion injury (IRI) is when an organ loses and then regains access to blood flow, commonly occurring with organ transplantation. The immune response elicited by IRI can be severe enough to negatively affect the function and survival of the donated organ. One of two main ways that the cells in the body communicate is through cytokines, which are secreted proteins that are present in the blood of transplant patients and can influence the degree of inflammation that occurs during and after IRI. Two characteristics that doctors use to determine if a patient is IRI+ or IRI- are the inflammation score, which is the amount of immune cells in the liver after transplant and the necorsis score, which is the amount of dead cells in the liver after transplant. These characteristics of inflammation and necrosis are scored from 0 to 4, with 0 being the least severe and 4 being the most severe.

## Sample data description:

The study includes 100 liver transplant patients, 42 of which are IRI+ and 58 IRI-. The analysis includes 23 cytokines. The data set also includes the inflammation score, necrosis score, and visit type for each patient.

## Variable assessment:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(haven)
library(gt)
library(tidyr)
library(ggforce) #can be used for large facet grids
library(dplyr)
library(gtsummary)
```

```{r}

data <- readxl::read_xlsx("./20210521_402a.xlsx", col_names = T, skip = 1)

str(data)

dataclean <- data %>% 
  rename(sample = "Sample #",
         patientid = "Patient ID",
         IRI = "IRI Score (–,+)",
         visittype = "Visit Type") %>% 
  mutate(across(starts_with("CYTO"),
                ~ dplyr::case_when(
                  str_starts(.x, "<") == T ~ as.numeric(str_sub(.x, 2, -2)),
                  str_starts(.x, ">") == T ~ as.numeric(str_sub(.x, 2, -2)) + 1,
                  str_starts(.x, "1|2|3|4|5|6|7|8|9|0") == T ~ as.numeric(.x)
                )))

```

```{r}
library(data.table)
isidata <- fread(file = "dataclean.csv", header = T, stringsAsFactors = F)
(isi_tble <- tibble(isidata))
```

Create patient characteristics table. 
```{r}
#namess
library(gtsummary)

CYTO <- names(isi_tble[7:29])  #vector of cytokine variable names 

demographic_table <- isi_tble %>% 
   mutate(IRI = ifelse( IRI == 0, "IRI-", "IRI+")) %>%
  select(-patientid, -sample) %>% 
  tbl_summary(by = IRI, 
              statistic = CYTO ~  
              "{median} ({p25}, {p75})",
              digits = all_continuous() ~ 2,
              label = list(visittype ~ "Visit Type"),
              missing_text = "Missing") %>% 
  add_overall() %>% 
  bold_labels() %>%
  add_p() %>% 
  bold_p() %>% 
  modify_header(label ~ "**Table 1. Patient Characteristics**" )
demographic_table
```

It should be noted that a significant difference between IRI- and IRI+ patients was detected for necrosis score (p <.001).

The significance test for cytokine concentration was conducted using a nonparametric method, so it is more robust to assumptions of normality. CYTO11, CYTO17, and CYTO22 were found to be significantly different. Next we visualize the distribution of cytokine concentration. 


```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

## my attempt to facet in one plot. Does not look good
isi_tble %>% select(starts_with("CYT")) %>%
  gather() %>%
  ggplot(aes(value)) +
facet_wrap(~ key, scales ="free") +
# facet_grid_paginate(~ key, ncol = 3, nrow = 3, page = 2)
  geom_boxplot()
```

The Cytokine distributions are characterized by heavy right skew. 

Now log transform all Cytokines
```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

* Among the log transformed cytokine values, it is seen that that overall normality is improved. 
 + CYTO12 and CYTO 19 appears to have a similar distribution when looking at the histogram, with large left skew and lack of density left of the peak density. 
 + CYTO13 appears as if it may have another peak in the right tail. It is right skewed. 
* CYTO 15 appears to have several outliers in the higher range.
* CYTO16 appears right skewed. 
* CYTO18 appears to have lower outliers. 
* CYTO17 has many values below level of detection, therefore the transformation did not affect overall normality. 
* CYTO21 appears to have a large right skew, though it should be noted that many values were below level of detection in CYTO 21. 

It should be noted that due to many observations below detection, CytO17 should not be included in the linear models that follow. 

### Cytokines Trending With Time by Anova 

First look at how cytokine values trend overtime
```{r}

library(ggpubr)


#Reordering the visittype 
isi_tble$visittype <- factor(isi_tble$visittype, levels = c("PO", "LF", "W1"))

#One-way anova at each timepoint 
for(i in c(7:29)){
p <- isi_tble %>% 
  ggplot() +
  geom_boxplot(aes(x = visittype, y = log(isi_tble[[i]]), color = visittype)) + 
  stat_compare_means(aes( x = visittype, y = log(isi_tble[[i]])), method = "anova",
                     label.y = (max(log(isi_tble[[i]])) + 1)) + #positions the anova stat 
  # stat_compare_means(aes( x = visittype, y = log(isi_tble[[i]])), label = "p.signif", method = "t.test",
  #                    ref.group = ".all.") + 
  geom_hline(yintercept = mean(log(isi_tble[[i]])), linetype = 2) + #adds horizontal line for mean 
  ggtitle(paste("Histogram of Log", names(isi_tble)[i], "by Visit Type")) + 
  ylab("pg/mL") + 
  xlab("Visit Type") + 
  theme_classic() 
print(p)
}
```


Only CYTO4, CYTO16, and CYTO17 concentrations are not significantly different at the different visits by one way anova. In all other cytokines, an overall difference in mean concentration was dtected. The overall mean at all timepoints is displayed with a horizontal line. 

CYTO2 at the LF timepoint appears significantly larger. 
CYTO7 at the LF timepoint appears significantly larger. 
CYTO13 at the LF timepoint appears significantly larger. 
In many of the cytokines, the concentration at the LF timepoint is larger, suggesting an elevated immune response during the LF timepoint. These cytokines include CYTO2, CYTO6, CYTO 7, CYTO13, CYTO20.
The concentration of CYTO22 appears to decrease at each timepoint. 

To investigate this further, pairwise comparisons will be conducted using Tukey's HSD. 

 
```{r}
# Log Transforming Data to use in anova modelling. 

liri_tble <- isi_tble %>% select(starts_with("CYT")) %>% 
  log() %>% #log transforms the cytokine data frame
  mutate(visittype = isi_tble$visittype, IRI = isi_tble$IRI, ID = isi_tble$patientid) #add the factor variables back in 
responseList <- names(liri_tble)[c(1:23)]

modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype"))
                           aov(mF, data = liri_tble)
                })

HSDList    <- lapply(modelList, function(mod) {
                           TukeyHSD(mod)
                })
HSDList
```
The Cytokines in which concentration at timepoint PO is significantly different from LF and W1, but LF and W1 are NOT significantly different from each other:
CYTO6, CYTO 7, CYTO10, CYTO13, and CYTO23. It should be noted that in CYTO23, concentration at LF was actually significantly lower than LF and W1. With the exception of CYTO23, these cytokines suggest that the LF timepoint is associated with an increased immune response. 

CYTO 2, CYTO13 and CYTO20 were significantly different for each pairwise comparison.  



To explore how cytokine concentrations trend over time in IRI positive and negative patients, interaction plots between IRI status and visit are visualized below.  Here median values are plotted over the visit types. It should be noted that CYTO4, CYTO16, and CYTO17 were not included because significance was not found in the anova test. 

```{r}
#need to add titles here 
#I use median instead of mean due to outliers in data set 
for(i in c(1:20)){
iri_tble2<- liri_tble %>% select(starts_with("CYTO"), -CYTO4, -CYTO16, -CYTO17)
    interaction.plot(x.factor = liri_tble$visittype,
                 response = liri_tble[[i]],
                 trace.factor = liri_tble$IRI,
                 fun = median,
                 ylab = "log(pg/mL)",
                 xlab = paste(names(iri_tble2)[i], "Visit Type"),
                 col = c("red", "blue"),
                 trace.label = "IRI Status") 
}
```
The interaction plots indicate possible interaction effect between IRI status and visit type in CYTO5, 7, 8, 14, 19 and 21.

To explore whether IRI status explains variation in cytokine concentrations, two-way anovas will be conducted with IRI status and visit type as factor levels. A separate anova for each cytokine concentration will be conducted. 
 


Running 2-Way ANOVA
```{r}
twoway_modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype*IRI"))
                           anova(lm(mF, data = isi_tble))
                })
twoway_modelList
```


A significant interaction is not observed in any of the models between IRI and visittype. IRI effect is significant explaining the variation in CYTO23 and CYTO22, which indicates IRI status is associated with CYTO23 and CYTO22 given visit type. 

Running Logistic Regression Models - Main Effects and Select Interactions
```{r logistic reg main effects, include = F}
#all cytokine values transformed with log2

#main effects
logdataclean <- dataclean %>% 
  mutate(across(starts_with("CYTO"), log2))
main.mod <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis -visittype, data = logdataclean, family = "binomial")
summary(main.mod)

# main effects leaving out visittype and checking for significance within each visit
podata <- logdataclean %>% filter(visittype == "PO") %>% 
  mutate(visittype = NULL)
po.mod <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis, data = podata, family = "binomial")
summary(po.mod)

lfdata <- logdataclean %>% filter(visittype == "LF") %>%
  mutate(visittype = NULL) 
lf.mod <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis, data = lfdata, family = "binomial")
summary(lf.mod)

w1data <- logdataclean %>% filter(visittype == "W1") %>%
  mutate(visittype = NULL)
w1.mod <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis, data = w1data, family = "binomial")
summary(w1.mod)

# main effects for changes from one visit to the next
prefix <- "CYTO"
suffix <- seq(1:23)
values <- paste(prefix, suffix, sep = "")

diffnames <- NULL
diffnames <- c(diffnames, paste(values, "diffs", sep = "."))

# wide data
iriwidedata <- logdataclean %>% 
  mutate(sample = NULL) %>% 
  pivot_wider (names_from = visittype, names_sep = ".", values_from = all_of(values))

# cyto change data
irichangedata <- logdataclean
setDT(irichangedata)[, c(diffnames) := lapply(.SD, 
      function(x) x-shift(x, fill=x[1L])), by = patientid, .SDcols=7:29]

# subset only change vars for model
changesubset <- irichangedata %>% 
  select(-Inflammation, -Necrosis, -visittype, -(CYTO1:CYTO23)) %>% 
  group_by(patientid) %>% 
  slice(2:n())

CYTObaseline <- logdataclean %>% 
  filter(visittype == "PO") %>% 
  select(patientid, CYTO1:CYTO23)

changesubsetbaseline <- left_join(changesubset, CYTObaseline, by = "patientid")

diff1subset <- changesubset %>% 
  group_by(patientid) %>% 
  slice(1)

diff2subset <- changesubset %>% 
  group_by(patientid) %>% 
  slice(2)


# change model
changemain.mod <- glm(IRI ~ . -sample -patientid, data = changesubset, family = "binomial")
summary(changemain.mod)
step(changemain.mod)

#Call:  glm(formula = IRI ~ 1, family = "binomial", data = changesubset)
# 
# Coefficients:
# (Intercept)  
#     -0.3228  
# 
# Degrees of Freedom: 199 Total (i.e. Null);  199 Residual
# Null Deviance:	    272.1 
# Residual Deviance: 272.1 	AIC: 274.1

# change model
changemainbase.mod <- glm(IRI ~ . -sample -patientid, data = changesubsetbaseline, family = "binomial")
summary(changemainbase.mod)
step(changemainbase.mod)

# glm(formula = IRI ~ CYTO9.diffs + CYTO18.diffs + CYTO22.diffs + 
#     CYTO1 + CYTO3 + CYTO4 + CYTO15 + CYTO16 + CYTO17 + CYTO21 + 
#     CYTO22 + CYTO23, family = "binomial", data = changesubsetbaseline)
# 
# Coefficients:
#  (Intercept)   CYTO9.diffs  CYTO18.diffs  CYTO22.diffs         CYTO1         CYTO3         CYTO4        CYTO15        CYTO16        CYTO17  
#      -2.1782       -0.2740        0.1561        0.3408        0.4156       -0.3627       -0.1527       -0.7015        0.5859       -0.8471  
#       CYTO21        CYTO22        CYTO23  
#      -0.2697        0.4244        0.8210  
# 
# Degrees of Freedom: 199 Total (i.e. Null);  187 Residual
# Null Deviance:	    272.1 
# Residual Deviance: 237.6 	AIC: 263.6

# only change from po to lf
changemain1.mod <- glm(IRI ~ . -sample -patientid, data = diff1subset, family = "binomial")
summary(changemain1.mod)
step(changemain1.mod)
# glm(formula = IRI ~ CYTO2.diffs + CYTO3.diffs + CYTO4.diffs + 
#     CYTO9.diffs + CYTO10.diffs + CYTO13.diffs + CYTO14.diffs + 
#     CYTO18.diffs + CYTO19.diffs + CYTO23.diffs, family = "binomial", 
#     data = diff1subset)
# 
# Coefficients:
#  (Intercept)   CYTO2.diffs   CYTO3.diffs   CYTO4.diffs   CYTO9.diffs  CYTO10.diffs  CYTO13.diffs  CYTO14.diffs  CYTO18.diffs  CYTO19.diffs  
#      -1.4014       -0.4890        0.5601        0.4316        1.5653        0.5286        0.2369       -0.7711        0.2313       -1.2389  
# CYTO23.diffs  
#      -0.6864  
# 
# Degrees of Freedom: 99 Total (i.e. Null);  89 Residual
# Null Deviance:	    136.1 
# Residual Deviance: 115.9 	AIC: 137.9

# only change from lf to w1
changemain2.mod <- glm(IRI ~ . -sample -patientid, data = diff2subset, family = "binomial")
summary(changemain2.mod)
step(changemain2.mod)
# glm(formula = IRI ~ CYTO2.diffs + CYTO4.diffs + CYTO9.diffs + 
#     CYTO13.diffs + CYTO14.diffs + CYTO16.diffs, family = "binomial", 
#     data = diff2subset)
# 
# Coefficients:
#  (Intercept)   CYTO2.diffs   CYTO4.diffs   CYTO9.diffs  CYTO13.diffs  CYTO14.diffs  CYTO16.diffs  
#      -1.4135        0.3515       -0.2009       -0.9077       -0.2089        0.6576        0.4266  
# 
# Degrees of Freedom: 99 Total (i.e. Null);  93 Residual
# Null Deviance:	    136.1 
# Residual Deviance: 114.2 	AIC: 128.2


# random effects - didn't work

# library(lme4)
# CYTOchange <- names(changesubset[4:26])
# eqn <- as.formula(paste("IRI ~ (1 | patientid)", 
#                         paste(CYTOchange, collapse = " + "), sep = "+"))
# randomeffects.changemod <- glmer(eqn, data = changesubset, family = "binomial", 
#                                  nAGQ = 30, control = glmerControl(optimizer= "bobyqa"))
# summary(randomeffects.changemod)
```


```{r logistic reg main effects without cyto17, include = F}

main.mod.17 <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis -visittype -CYTO17, data = logdataclean, family = "binomial")
summary(main.mod.17)
# CYTO1 0.1
# CYTO16 0.1
# CYTO18 0.05
# CYTO22 0.05
main.table <- main.mod.17 %>% 
  tbl_regression(include = c("CYTO1", "CYTO16", "CYTO18", "CYTO22"), intercept = T) %>% 
  bold_p(t = 0.1)

# main effects leaving out visittype and checking for significance within each visit
po.mod.17 <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis -CYTO17, data = podata, family = "binomial")
summary(po.mod.17)
# CYTO3 0.1
# CYTO15 0.1
# CYTO16 0.1
# CYTO23 0.1
po.table <- po.mod.17 %>% 
  tbl_regression(include = c("CYTO3", "CYTO15", "CYTO16", "CYTO23"), intercept = T) %>% 
  bold_p(t = 0.1)

lf.mod.17 <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis -CYTO17, data = lfdata, family = "binomial")
summary(lf.mod.17)
# CYTO1 0.05
# CYTO2 0.05
# CYTO11 0.05
# CYTO13 0.1
# CYTO14 0.1
lf.table <- lf.mod.17 %>% 
  tbl_regression(include = c("CYTO1", "CYTO2", "CYTO11", "CYTO13", "CYTO14"), intercept = T) %>% 
  bold_p(t = 0.1)

w1.mod.17 <- glm(IRI ~ . -sample -patientid -Inflammation -Necrosis -CYTO17, data = w1data, family = "binomial")
summary(w1.mod.17)
# CYTO9 0.05
# CYTO13 0.1
# CYTO18 0.1
# CYTO22 0.05
w1.table <- w1.mod.17 %>% 
  tbl_regression(include = c("CYTO9", "CYTO13", "CYTO18", "CYTO22"), intercept = T) %>% 
  bold_p(t = 0.1)

# change model
changemain.mod.17 <- glm(IRI ~ . -sample -patientid -CYTO17.diffs, data = changesubset, family = "binomial")
summary(changemain.mod.17)
# CYTO9.diffs 0.1
changemain.table <- changemain.mod.17 %>% 
  tbl_regression(include = c("CYTO9.diffs"), intercept = T) %>% 
  bold_p(t = 0.1)

step(changemain.mod.17)
# yields null model, not significant

# change model
changemainbase.mod.17 <- glm(IRI ~ . -sample -patientid -CYTO17.diffs -CYTO17, data = changesubsetbaseline, family = "binomial")
summary(changemainbase.mod.17)
# CYTO9.diffs 0.1
# CYTO1 0.1
# CYTO3 0.05
# CYTO15 0.05
# CYTO16 0.05
# CYTO23 0.05
changemainbase.table <- changemainbase.mod.17 %>% 
  tbl_regression(include = c("CYTO9.diffs", "CYTO1", "CYTO3", "CYTO15",
                             "CYTO16", "CYTO23"), intercept = T) %>% 
  bold_p(t = 0.1)

step(changemainbase.mod.17)

# glm(formula = IRI ~ CYTO16.diffs + CYTO1 + CYTO3 + CYTO15 + CYTO16 + 
#     CYTO22 + CYTO23, family = "binomial", data = changesubsetbaseline)
# 
# Coefficients:
#  (Intercept)  CYTO16.diffs         CYTO1         CYTO3        CYTO15        CYTO16        CYTO22        CYTO23  
#      -2.5005        0.2666        0.3085       -0.2818       -0.7830        0.5465        0.2642        0.6724  
# 
# Degrees of Freedom: 199 Total (i.e. Null);  192 Residual
# Null Deviance:	    272.1 
# Residual Deviance: 247.3 	AIC: 263.3

# only change from po to lf
changemain1.mod.17 <- glm(IRI ~ . -sample -patientid -CYTO17.diffs, data = diff1subset, family = "binomial")
summary(changemain1.mod.17)
# Intercept 0.05 down
# CYTO2.diffs 0.1 down
# CYTO3.diffs 0.1  up
# CYTO4.diffs 0.05 up
# CYTO9.diffs 0.05 up
# CYTO10.diffs 0.1 up
# CYTO14.diffs 0.05 down
# CYTO19.diffs 0.1 down


library(gtsummary)
changemain1.table <- changemain1.mod.17 %>% 
  tbl_regression(include = c("CYTO2.diffs", "CYTO3.diffs",
                             "CYTO4.diffs", "CYTO9.diffs", "CYTO10.diffs",
                             "CYTO14.diffs", "CYTO19.diffs"), intercept = T) %>% 
  bold_p(t = 0.1)

step(changemain1.mod.17)
#glm(formula = IRI ~ CYTO2.diffs + CYTO3.diffs + CYTO4.diffs + 
#     CYTO9.diffs + CYTO10.diffs + CYTO13.diffs + CYTO14.diffs + 
#     CYTO18.diffs + CYTO19.diffs + CYTO23.diffs, family = "binomial", 
#     data = diff1subset)
# 
# Coefficients:
#  (Intercept)   CYTO2.diffs   CYTO3.diffs   CYTO4.diffs   CYTO9.diffs  CYTO10.diffs  CYTO13.diffs  CYTO14.diffs  CYTO18.diffs  CYTO19.diffs  
#      -1.4014       -0.4890        0.5601        0.4316        1.5653        0.5286        0.2369       -0.7711        0.2313       -1.2389  
# CYTO23.diffs  
#      -0.6864  
# 
# Degrees of Freedom: 99 Total (i.e. Null);  89 Residual
# Null Deviance:	    136.1 
# Residual Deviance: 115.9 	AIC: 137.9

# only change from lf to w1
changemain2.mod.17 <- glm(IRI ~ . -sample -patientid -CYTO17.diffs, data = diff2subset, family = "binomial")
summary(changemain2.mod.17)
# CYTO2.diffs 0.1 up
# CYTO9.diffs 0.01 down
changemain2.table <- changemain2.mod.17 %>% 
  tbl_regression(include = c("CYTO2.diffs", "CYTO9.diffs"), intercept = T) %>% 
  bold_p(t = 0.1)

step(changemain2.mod.17)
# glm(formula = IRI ~ CYTO2.diffs + CYTO4.diffs + CYTO9.diffs + 
#     CYTO13.diffs + CYTO14.diffs + CYTO16.diffs, family = "binomial", 
#     data = diff2subset)
# 
# Coefficients:
#  (Intercept)   CYTO2.diffs   CYTO4.diffs   CYTO9.diffs  CYTO13.diffs  CYTO14.diffs  CYTO16.diffs  
#      -1.4135        0.3515       -0.2009       -0.9077       -0.2089        0.6576        0.4266  
# 
# Degrees of Freedom: 99 Total (i.e. Null);  93 Residual
# Null Deviance:	    136.1 
# Residual Deviance: 114.2 	AIC: 128.2
```

```{r logistic reg step interactions no 17, include = F}

# took significant predictors at 0.1 level and included them in this model to check for interactions
# then take step function and report final step
int.mod.17 <- glm(IRI ~ (CYTO1 + CYTO16 + CYTO18 + CYTO22)^2, data = logdataclean, family = "binomial")
summary(int.mod.17)
stepint.mod.17 <- step(int.mod.17)
stepint.table <- stepint.mod.17 %>% 
  tbl_regression(intercept = T) %>% 
  bold_p(t = 0.1)

# main effects leaving out visittype and checking for significance within each visit
# took significant predictors at 0.1 level and included them in this model to check for interactions
# then take step function and report final step
point.mod.17 <- glm(IRI ~ (CYTO3 + CYTO15 + CYTO16 + CYTO23)^2, data = podata, family = "binomial")
summary(point.mod.17)
steppoint.mod.17 <- step(point.mod.17)
steppoint.table <- steppoint.mod.17 %>% 
  tbl_regression(intercept = T) %>% 
  bold_p(t = 0.1)


# took significant predictors at 0.1 level and included them in this model to check for interactions
# then take step function and report final step
lfint.mod.17 <- glm(IRI ~ (CYTO1 + CYTO2 + CYTO11 + CYTO13 + CYTO14)^2, data = lfdata, family = "binomial")
summary(lfint.mod.17)
steplfint.mod.17 <- step(lfint.mod.17)
steplfint.table <- steplfint.mod.17 %>% 
  tbl_regression(intercept = T) %>% 
  bold_p(t = 0.1)

# took significant predictors at 0.1 level and included them in this model to check for interactions
# then take step function and report final step
w1int.mod.17 <- glm(IRI ~ (CYTO9 + CYTO13 + CYTO18 + CYTO22)^2, data = w1data, family = "binomial")
summary(w1int.mod.17)
stepw1int.mod.17 <- step(w1int.mod.17)
stepw1int.table <- stepw1int.mod.17 %>% 
  tbl_regression(intercept = T) %>% 
  bold_p(t = 0.1)


# change model, note: does not use output of step from main effects bc that was just null model
# note: does not converge
# changeint.mod.17 <- glm(IRI ~ (. -sample -patientid -CYTO17.diffs)^2, data = changesubset, family = "binomial")
# summary(changeint.mod.17)
# stepint.mod <- step(changeint.mod.17)
# stepint.table <- stepint.mod %>% 
#   tbl_regression(intercept = T)

# change model
changeintbase.mod.17 <- glm(formula = IRI ~ (CYTO16.diffs + CYTO1 + CYTO3 + CYTO15 + CYTO16 + 
     CYTO22 + CYTO23)^2, family = "binomial", data = changesubsetbaseline)
summary(changeintbase.mod.17)

stepintbase.mod <- step(changeintbase.mod.17)
stepintbase.table <- stepintbase.mod %>% 
  tbl_regression(intercept = T) %>% 
  bold_p(t = 0.1)

# only change from po to lf note: does not converge
# changeint1.mod.17 <- glm(formula = IRI ~ (CYTO2.diffs + CYTO3.diffs + CYTO4.diffs + 
#      CYTO9.diffs + CYTO10.diffs + CYTO13.diffs + CYTO14.diffs + 
#      CYTO18.diffs + CYTO19.diffs + CYTO23.diffs)^2, family = "binomial", 
#      data = diff1subset)
# summary(changeint1.mod.17)
# 
# stepint1.mod <- step(changeint1.mod.17)
# stepint1.table <- stepint1.mod %>% 
#   tbl_regression(intercept = T)


# only change from lf to w1
changeint2.mod.17 <- glm(formula = IRI ~ (CYTO2.diffs + CYTO4.diffs + CYTO9.diffs + 
CYTO13.diffs + CYTO14.diffs + CYTO16.diffs)^2, family = "binomial", 
data = diff2subset)
summary(changeint2.mod.17)

stepint2.mod <- step(changeint2.mod.17)
stepint2.table <- stepint2.mod %>% 
  tbl_regression(intercept = T) %>%
  bold_p(t = 0.1)



```

Correlation Plots
```{r corr plot}
library(ggcorrplot)
corr.main <- round(cor(logdataclean[,c(3, 7:29)]), 3)
corr.change <- round(cor(changesubset[,3:26]), 3)
pcorr.change <- round(cor_pmat(changesubset[,3:26]), 3)

corr.diff1 <- round(cor(diff1subset[,3:26]), 3)
pcorr.diff1 <- round(cor_pmat(diff1subset[,3:26]), 3)

corr.diff2 <- round(cor(diff2subset[,3:26]), 3)
pcorr.diff2 <- round(cor_pmat(diff2subset[,3:26]), 3)

ggcorrplot(corr.main, outline.col = "white", type = "lower")
ggcorrplot(corr.change, outline.col = "white", type = "lower")
ggcorrplot(corr.diff1, outline.col = "white", type = "lower")
ggcorrplot(corr.diff2, outline.col = "white", type = "lower")

```


```{r print tbl regression outputs}

# did not include interaction model for change models due to not all models converging

main.table 
po.table 
lf.table 
w1.table 

stepint.table
steppoint.table
steplfint.table
stepw1int.table

changemain.table
changemainbase.table
changemain1.table
changemain2.table


```

Trying to run logistic model with patient ID as a random effect. 
```{r}
library(lme4)
library(MASS)


#liri_tble[ ,c(1:23)] <- scale(liri_tble[ ,c(1:23)])

CYTO <- names(liri_tble[1:23])
eqn <- as.formula(paste("IRI ~ (1 | ID)", paste(CYTO, collapse = " + "), sep = "+"))

liri_tble$visittype <- as.numeric(liri_tble$visittype)
#logistic mixed model using time and intercept as a mrandom effect for each patient ID 
random <- glmer(eqn, data = liri_tble, family = binomial, nAGQ = 0, control=glmerControl(optimizer="bobyqa"))
summary(random)
``` 


## Analysis of data set:

Question 2: What cytokines in the pre-transplant blood sample specifically correlate with:

a. Immune cell infiltration after transplant? (Inflammation score)

Since we are looking at cytokines in pre-transplant blood samples, we first filter for pre-operation data.

```{r}
# filter for preoperation data
dataPO <- dataclean %>% 
  filter(visittype == "PO")

# crosstabs on preoperation data
xtabs(~ Inflammation, data = dataPO)
xtabs(~ Necrosis, data = dataPO)
```

We reassign the numerical inflammation scores to reflect  negative and positive scores.

```{r}
dataPO1 <- dataPO

# reassigning inflammation scores 0=negative and 2=positive
dataPO1$Inflammation[dataPO$Inflammation == 0] <- 0
dataPO1$Inflammation[dataPO$Inflammation == 1] <- 0

dataPO1$Inflammation[dataPO$Inflammation == 2] <- 2
dataPO1$Inflammation[dataPO$Inflammation == 3] <- 2
dataPO1$Inflammation[dataPO$Inflammation == 4] <- 2


# reassigning necrosis scores 0=negative and 2=positive
dataPO1$Necrosis[dataPO$Necrosis == 0] <- 0
dataPO1$Necrosis[dataPO$Necrosis == 1] <- 0

dataPO1$Necrosis[dataPO$Necrosis == 2] <- 2
dataPO1$Necrosis[dataPO$Necrosis == 3] <- 2
dataPO1$Necrosis[dataPO$Necrosis == 4] <- 2

# crosstabs to check that reassigned values match original data
xtabs(~ Inflammation, data = dataPO1)
xtabs(~ Necrosis, data = dataPO1)
```

We attempt an ordinal logistic regression model with the numeric inflammation scores. The confidence interval for cytokine 23 does not include 0, which suggests that it may be statistically significant.

```{r}
library(MASS)
# releveled inflammation as factor
dataPO$Inflammation <- factor(dataPO$Inflammation, levels = c("0", "1", "2", "3", "4"))
dataPO$Inflammation

# ordinal logistic regression model
m1 <- polr(Inflammation ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO, Hess=TRUE)
summary(m1)

## store table
(ctable1 <- coef(summary(m1)))

## calculate and store p values
p1 <- pnorm(abs(ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable1 <- cbind(ctable1, "p value" = p1))

# CIs assuming normality
confint.default(m1)

#Using step function 
step_m1 <- step(m1, trace = F)
```

We also attempt a binary response model with the positive/negative inflammation scores, which seems to be a better fitted model. The confidence intervals for cytokine 4, 9, 10, and 23 do not include 0, which suggests that it may be statistically significant.

```{r Research Question 2}

xtabs(~ Inflammation, data = dataclean)
xtabs(~ Necrosis, data = dataclean)

# split outcomes (Inflammation or Necrosis Score) with 0-1 vs 2+ as -/+
# try two types of models: ordered factor outcome and binary outcome (try both)
```
```{r}
# releveled inflammation as factor
dataPO1$Inflammation <- factor(dataPO1$Inflammation)

# binary response model
m3 <- glm(Inflammation ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO1, family = "binomial")
summary(m3)

# CIs assuming normality
confint.default(m3)
```

We also try a stepwise regression model, which gives the best fittedd model. Cytokines 9, 16, 18, and 23 have p-values less than 0.05, which suggests that they may specifically correlate with immune cell infiltration after transplant.

```{r}
library(caret)
library(leaps)
library(MASS)

# Stepwise regression model
step.model <- stepAIC(m3, direction = "both", trace = FALSE)
# step.model <- full.model %>% stepAIC(trace = FALSE)

# Fit the full model 
full.model <- lm(Inflammation ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO17 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO1)

# Stepwise regression model
step.model <- stepAIC(full.model, direction = "both", trace = FALSE)

summary(step.model)
```


b. Dead cells in the liver after transplant? (Necrosis score)

We attempt an ordinal logistic regression model on the numerical necrosis scores. All of the confidence intervals include 0, so none of the cytokines appear to be statistically significant.

```{r}
library(MASS)
# releveled necrosis as factor
dataPO$Necrosis <- factor(dataPO$Necrosis, levels = c("0", "1", "2", "3", "4"))
dataPO$Necrosis

# ordinal logistic regression model
m2 <- polr(Necrosis ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5  + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO, Hess=TRUE)
summary(m2)

## store table
(ctable2 <- coef(summary(m2)))

## calculate and store p values
p2 <- pnorm(abs(ctable2[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable2 <- cbind(ctable2, "p value" = p2))

# CIs assuming normality
confint.default(m2)
```

We also attempt a binary response model on the positive/negative necrosis scores, which gives a better fitted model. Again, all of the confidence intervals include 0, so none of the cytokines appear to be statistically significant.

```{r}
# releveled necrosis as factor
dataPO1$Necrosis <- factor(dataPO1$Necrosis)

#binary response model
m4 <- glm(Necrosis ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO17 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO1, family = "binomial")
summary(m4)

# CIs assuming normality
confint.default(m4)
```

We also try a stepwise regression model, which gives the best fitted model. Cytokine 1 has a p-value less than 0.05, which suggests that this cytokine specifically correlates with the dead cells in the liver after transplant.

```{r}
library(caret)
library(leaps)
library(MASS)

# Stepwise regression model
step.model <- stepAIC(m4, direction = "both", 
                      trace = FALSE)
summary(step.model)
```


## Interpretation of results in terms of the original research hypotheses:


---
title: "B402A Assignment 7"
author: "Lillian Chen, Milan Filipovic, Vivian Truong"
date: "5/24/2021"
output:
  html_document:
    df_print: paged
---

# Allyson Terry’s study on immunologic response to liver allograft injury

## Statement of statistical hypothesis(es):

1. What cytokines are significantly different between IRI- and IRI+ patients in the larger cohort of 100 liver transplant patients?

a. Do these cytokines influence IRI individually?
b. Do these cytokines influence IRI together?
c. Are any of these cytokines significantly different at more than one timepoint?

2. What cytokines in the pre-transplant blood sample specifically correlate with:

a. Immune cell infiltration after transplant? (Inflammation score)
b. Dead cells in the liver after transplant? (Necrosis score)

## Background information:

Ischemia-reperfusion injury (IRI) is when an organ loses and then regains access to blood flow, commonly occurring with organ transplantation. The immune response elicited by IRI can be severe enough to negatively affect the function and survival of the donated organ. One of two main ways that the cells in the body communicate is through cytokines, which are secreted proteins that are present in the blood of transplant patients and can influence the degree of inflammation that occurs during and after IRI. Two characteristics that doctors use to determine if a patient is IRI+ or IRI- are the inflammation score, which is the amount of immune cells in the liver after transplant and the necorsis score, which is the amount of dead cells in the liver after transplant. These characteristics of inflammation and necrosis are scored from 0 to 4, with 0 being the least severe and 4 being the most severe.

## Sample data description:

The study includes 100 liver transplant patients, 42 of which are IRI+ and 58 IRI-. The analysis includes 23 cytokines. The data set also includes the inflammation score, necrosis score, and visit type for each patient.

## Variable assessment:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(haven)
library(gt)
library(tidyr)
library(ggforce) #can be used for large facet grids
library(dplyr)
```

```{r}

data <- readxl::read_xlsx("./20210521_402a.xlsx", col_names = T, skip = 1)

str(data)

dataclean <- data %>% 
  rename(sample = "Sample #",
         patientid = "Patient ID",
         IRI = "IRI Score (–,+)",
         visittype = "Visit Type") %>% 
  mutate(across(starts_with("CYTO"),
                ~ dplyr::case_when(
                  str_starts(.x, "<") == T ~ as.numeric(str_sub(.x, 2, -2)),
                  str_starts(.x, ">") == T ~ as.numeric(str_sub(.x, 2, -2)) + 1,
                  str_starts(.x, "1|2|3|4|5|6|7|8|9|0") == T ~ as.numeric(.x)
                )))

```

```{r}
library(data.table)
isidata <- fread(file = "dataclean.csv", header = T, stringsAsFactors = F)
(isi_tble <- tibble(isidata))
```

We begin by visualizing the distribution of cytokine values 



```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram()

## my attempt to facet in one plot. Does not look good
isi_tble %>% select(starts_with("CYT")) %>%
  gather() %>%
  ggplot(aes(value)) +
facet_wrap(~ key, scales ="free") +
# facet_grid_paginate(~ key, ncol = 3, nrow = 3, page = 2)
  geom_boxplot()
```

The Cytokine distributions are characterized by heavy right skew. 

Now log transform all Cytokines
```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_histogram() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

```{r}

isi_tble %>% 
  select(CYTO1:CYTO6) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO7:CYTO12) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO13:CYTO18) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")

isi_tble %>% 
  select(CYTO19:CYTO23) %>% 
  gather() %>% 
  ggplot(aes(log(value))) + 
 facet_wrap(~ key, nrow = 3, scales = "free") + 
  geom_boxplot() + 
  labs(title = "Log Transformed") +
  xlab("log pg/mL")


```

* Among the log transformed cytokine values, it is seen that that overall normality is improved. 
 + CYTO12 and CYTO 19 appears to have a similar distribution when looking at the histogram, with large left skew and lack of density left of the peak density. 
 + CYTO13 appears as if it may have another peak in the right tail. It is right skewed. 
* CYTO 15 appears to have several outliers in the higher range.
* CYTO16 appears right skewed. 
* CYTO18 appears to have lower outliers. 
* CYTO17 has many values below level of detection, therefore the transformation did not affect overall normality. 
* CYTO21 appears to have a large right skew, though it should be noted that many values were below level of detection in CYTO 21. 


### Cytokines Trending With Time by Anova 

First look at how cytokine values trend overtime
```{r}

library(ggpubr)


#Reordering the visittype 
isi_tble$visittype <- factor(isi_tble$visittype, levels = c("PO", "LF", "W1"))

#One-way anova at each timepoint 
for(i in c(7:29)){
p <- isi_tble %>% 
  ggplot() +
  geom_boxplot(aes(x = visittype, y = log(isi_tble[[i]]), color = visittype)) + 
  stat_compare_means(aes( x = visittype, y = log(isi_tble[[i]])), method = "anova",
                     label.y = (max(log(isi_tble[[i]])) + 1)) + #positions the anova stat 
  # stat_compare_means(aes( x = visittype, y = log(isi_tble[[i]])), label = "p.signif", method = "t.test",
  #                    ref.group = ".all.") + 
  geom_hline(yintercept = mean(log(isi_tble[[i]])), linetype = 2) + #adds horizontal line for mean 
  ggtitle(paste("Histogram of Log", names(isi_tble)[i], "by Visit Type")) + 
  ylab("pg/mL") + 
  xlab("Visit Type") + 
  theme_classic() 
print(p)
}
```


Only CYTO4, CYTO16, and CYTO17 are not significantly different by one way anova. 

CYTO2 at the LF timepoint appears significantly larger. 
CYTO7 at the LF timepoint appears significantly larger. 
CYTO13 at the LF timepoint appears significantly larger. 
In many of the cytokines, the concentration at the LF timepoint is larger, suggesting an elevated immune response during the LF timepoint. These cytokines include CYTO2, CYTO6, CYTO 7, CYTO13, CYTO20.
The concentration of CYTO22 appears to decrease at each timepoint. 


Log Transforming Data to use in anova modelling. 
```{r}
liri_tble <- isi_tble %>% select(starts_with("CYT")) %>% 
  log() %>% #log transforms the cytokine data frame
  mutate(visittype = isi_tble$visittype, IRI = isi_tble$IRI, ID = isi_tble$patientid) #add the factor variables back in 
liri_tble 
```


A one-way anova to compare cytokine concentrations for different timepoints. A pairwise comparison for all  
```{r}
responseList <- names(liri_tble)[c(1:23)]
modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype"))
                           aov(mF, data = liri_tble)
                })

HSDList    <- lapply(modelList, function(mod) {
                           TukeyHSD(mod)
                })
HSDList
```
The Cytokines in which concentration at timepoint PO is significantly different from LF and W1, but LF and W1 are NOT significantly different from each other:
CYTO6, CYTO 7, CYTO10, CYTO13, and CYTO23. It should be noted that in CYTO23, concentration at LF was actually significantly lower than LF and W1. CYTO 2, CYTO13 and CYTO20 were significantly different at every timepoint. 



Two-way Interaction Plot. Here median values are plotted over the visit types. It should be noted that CYTO4, CYTO16, and CYTO17 were not included because significance was not found in the anova test. 
```{r}
#need to add titles here 
#I use median instead of mean due to outliers in data set 
for(i in c(1:20)){
iri_tble2<- liri_tble %>% select(starts_with("CYTO"), -CYTO4, -CYTO16, -CYTO17)
    interaction.plot(x.factor = liri_tble$visittype,
                 response = liri_tble[[i]],
                 trace.factor = liri_tble$IRI,
                 fun = median,
                 ylab = "pg/mL",
                 xlab = paste(names(iri_tble2)[i], "Visit Type"),
                 col = c("red", "blue"),
                 trace.label = "IRI Status")
}
```


Possible interaction effect between ISI status and visit type in CYTO5, 7, 8, 14, 19 and 21. 


Running two-way anova 
```{r}
twoway_modelList    <- lapply(responseList, function(resp) {
                           mF <- formula(paste(resp, " ~ visittype*IRI"))
                           anova(lm(mF, data = isi_tble))
                })
twoway_modelList
```


A significant interaction is not observed in any of the models between ISI and visittype. IRI effect is significant explaining the variation in CYTO23 and CYTO22, which indicates IRI status is associated with CYTO23 and CYTO22 given visit type. 



Trying to run logistic model with patient ID as a random effect. 
```{r}
library(lme4)
library(MASS)


#liri_tble[ ,c(1:23)] <- scale(liri_tble[ ,c(1:23)])

CYTO <- names(liri_tble[1:23])
eqn <- as.formula(paste("IRI ~ (1 | ID)", paste(CYTO, collapse = " + "), sep = "+"))

liri_tble$visittype <- as.numeric(liri_tble$visittype)
#logistic mixed model using time and intercept as a mrandom effect for each patient ID 
random <- glmer(eqn, data = liri_tble, family = binomial, nAGQ = 0, control=glmerControl(optimizer="bobyqa"))
summary(random)
``` 


## Analysis of data set:

Question 2: What cytokines in the pre-transplant blood sample specifically correlate with:

a. Immune cell infiltration after transplant? (Inflammation score)

Since we are looking at cytokines in pre-transplant blood samples, we first filter for pre-operation data.

```{r}
# filter for preoperation data
dataPO <- dataclean %>% 
  filter(visittype == "PO")

# crosstabs on preoperation data
xtabs(~ Inflammation, data = dataPO)
xtabs(~ Necrosis, data = dataPO)
```

We reassign the numerical inflammation scores to reflect  negative and positive scores.

```{r}
dataPO1 <- dataPO

# reassigning inflammation scores 0=negative and 2=positive
dataPO1$Inflammation[dataPO$Inflammation == 0] <- 0
dataPO1$Inflammation[dataPO$Inflammation == 1] <- 0

dataPO1$Inflammation[dataPO$Inflammation == 2] <- 2
dataPO1$Inflammation[dataPO$Inflammation == 3] <- 2
dataPO1$Inflammation[dataPO$Inflammation == 4] <- 2

# reassigning necrosis scores 0=negative and 2=positive
dataPO1$Necrosis[dataPO$Necrosis == 0] <- 0
dataPO1$Necrosis[dataPO$Necrosis == 1] <- 0

dataPO1$Necrosis[dataPO$Necrosis == 2] <- 2
dataPO1$Necrosis[dataPO$Necrosis == 3] <- 2
dataPO1$Necrosis[dataPO$Necrosis == 4] <- 2

# crosstabs to check that reassigned values match original data
xtabs(~ Inflammation, data = dataPO1)
xtabs(~ Necrosis, data = dataPO1)
```

We attempt an ordinal logistic regression model with the numeric inflammation scores. The confidence interval for cytokine 23 does not include 0, which suggests that it may be statistically significant.

```{r}
library(MASS)
# releveled inflammation as factor
dataPO$Inflammation <- factor(dataPO$Inflammation, levels = c("0", "1", "2", "3", "4"))
dataPO$Inflammation

# ordinal logistic regression model
m1 <- polr(Inflammation ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO, Hess=TRUE)
summary(m1)

## store table
(ctable1 <- coef(summary(m1)))

## calculate and store p values
p1 <- pnorm(abs(ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable1 <- cbind(ctable1, "p value" = p1))

# CIs assuming normality
confint.default(m1)

#Using step function 
step_m1 <- step(m1, trace = F)
```

We also attempt a binary response model with the positive/negative inflammation scores, which seems to be a better fitted model. The confidence intervals for cytokine 4, 9, 10, and 23 do not include 0, which suggests that it may be statistically significant.

```{r}
# releveled inflammation as factor
dataPO1$Inflammation <- factor(dataPO1$Inflammation)

# binary response model
m3 <- glm(Inflammation ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO1, family = "binomial")
summary(m3)

# CIs assuming normality
confint.default(m3)
```

We also try a stepwise regression model, which gives the best fittedd model. Cytokines 9, 16, 18, and 23 have p-values less than 0.05, which suggests that they may specifically correlate with immune cell infiltration after transplant.

```{r}
library(caret)
library(leaps)
library(MASS)

# Stepwise regression model
step.model <- stepAIC(m3, direction = "both", trace = FALSE)
# step.model <- full.model %>% stepAIC(trace = FALSE)

summary(step.model)
```


b. Dead cells in the liver after transplant? (Necrosis score)

We attempt an ordinal logistic regression model on the numerical necrosis scores. All of the confidence intervals include 0, so none of the cytokines appear to be statistically significant.

```{r}
library(MASS)
# releveled necrosis as factor
dataPO$Necrosis <- factor(dataPO$Necrosis, levels = c("0", "1", "2", "3", "4"))
dataPO$Necrosis

# ordinal logistic regression model
m2 <- polr(Necrosis ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5  + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO, Hess=TRUE)
summary(m2)

## store table
(ctable2 <- coef(summary(m2)))

## calculate and store p values
p2 <- pnorm(abs(ctable2[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable2 <- cbind(ctable2, "p value" = p2))

# CIs assuming normality
confint.default(m2)
```

We also attempt a binary response model on the positive/negative necrosis scores, which gives a better fitted model. Again, all of the confidence intervals include 0, so none of the cytokines appear to be statistically significant.

```{r}
# releveled necrosis as factor
dataPO1$Necrosis <- factor(dataPO1$Necrosis)

#binary response model
m4 <- glm(Necrosis ~ CYTO1 + CYTO2 + CYTO3 + CYTO4 + CYTO5 + CYTO6 + CYTO7 + CYTO8 + CYTO9 + CYTO10 + CYTO11 + CYTO12 + CYTO13 + CYTO14 + CYTO15 + CYTO16 + CYTO17 + CYTO18 + CYTO19 + CYTO20 + CYTO21 + CYTO22 + CYTO23, data = dataPO1, family = "binomial")
summary(m4)

# CIs assuming normality
confint.default(m4)
```

We also try a stepwise regression model, which gives the best fitted model. Cytokine 1 has a p-value less than 0.05, which suggests that this cytokine specifically correlates with the dead cells in the liver after transplant.

```{r}
library(caret)
library(leaps)
library(MASS)

# Stepwise regression model
step.model <- stepAIC(m4, direction = "both", 
                      trace = FALSE)
summary(step.model)
```


## Interpretation of results in terms of the original research hypotheses: